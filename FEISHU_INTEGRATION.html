<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è”ç³»æˆ‘ä»¬ - æ¸¯åŸ é›¨æ—ç”œç¬‹ï¼ˆé£ä¹¦é›†æˆç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-2xl mx-auto pt-8">
        <!-- æ ‡é¢˜ -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-4">ğŸ‹ æ¸¯åŸ é›¨æ—ç”œç¬‹</h1>
            <p class="text-white/90 text-lg">äº§å“å’¨è¯¢ä¸åˆä½œæ´½è°ˆ</p>
            <div class="mt-2">
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">
                    ğŸ”„ æ•°æ®å®æ—¶åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼
                </span>
            </div>
        </div>

        <!-- è”ç³»è¡¨å• -->
        <div class="glass-effect rounded-3xl shadow-2xl p-8">
            <form id="contactForm">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        ğŸ‘¤ æ‚¨çš„å§“å *
                    </label>
                    <input type="text" id="name" name="name" required
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        ğŸ“± æ‰‹æœºå·ç  *
                    </label>
                    <input type="tel" id="phone" name="phone" required
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰‹æœºå·ç ">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        ğŸ“§ é‚®ç®±åœ°å€
                    </label>
                    <input type="email" id="email" name="email"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ï¼ˆå¯é€‰ï¼‰">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        ğŸ’¬ ç•™è¨€å†…å®¹ *
                    </label>
                    <textarea id="message" name="message" rows="5" required
                              class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none transition-colors resize-none"
                              placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„éœ€æ±‚æˆ–é—®é¢˜..."></textarea>
                </div>

                <button type="submit" id="submitBtn"
                        class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 px-6 rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all duration-200 transform hover:scale-[1.02] flex items-center justify-center gap-2">
                    <span id="btnText">æäº¤å’¨è¯¢</span>
                    <div id="btnLoading" class="loading hidden"></div>
                </button>
            </form>

            <!-- çŠ¶æ€æ˜¾ç¤º -->
            <div id="statusMessage" class="mt-4 hidden"></div>

            <!-- å¤‡ç”¨è”ç³»æ–¹å¼ -->
            <div class="mt-8 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“ å…¶ä»–è”ç³»æ–¹å¼</h3>
                <div class="space-y-2">
                    <p class="text-gray-600">ğŸ“± å®¢æœçƒ­çº¿ï¼š<strong>18510890322</strong></p>
                    <p class="text-gray-600">ğŸ“§ é‚®ç®±å’¨è¯¢ï¼š<strong>xixi@gbylbj.com</strong></p>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åŒæ­¥çŠ¶æ€ -->
        <div class="glass-effect rounded-xl shadow-xl p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ“Š æ•°æ®åŒæ­¥çŠ¶æ€</h3>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600" id="syncStatus">âœ… æ­£å¸¸</div>
                    <div class="text-gray-600 text-sm">åŒæ­¥çŠ¶æ€</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalSubmissions">0</div>
                    <div class="text-gray-600 text-sm">æ€»ç•™è¨€æ•°</div>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å‘˜å…¥å£ -->
        <div class="glass-effect rounded-xl shadow-xl p-6 mt-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ” ç®¡ç†å‘˜</h3>
            <div class="flex flex-wrap gap-3">
                <button onclick="showConfigPanel()"
                        class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    âš™ï¸ é£ä¹¦é…ç½®
                </button>
                <button onclick="testFeishuConnection()"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    ğŸ”— æµ‹è¯•è¿æ¥
                </button>
                <button onclick="openFeishuTable()"
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    ğŸ“Š æ‰“å¼€é£ä¹¦è¡¨æ ¼
                </button>
            </div>
        </div>

        <!-- é…ç½®é¢æ¿ -->
        <div id="configPanel" class="glass-effect rounded-xl shadow-xl p-6 mt-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-6">âš™ï¸ é£ä¹¦é…ç½®</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">åº”ç”¨ID (App ID)</label>
                    <input type="text" id="appId" placeholder="cli_xxxxxxxxxxxxxxxx"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">åº”ç”¨å¯†é’¥ (App Secret)</label>
                    <input type="password" id="appSecret" placeholder="è¯·è¾“å…¥åº”ç”¨å¯†é’¥"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">å¤šç»´è¡¨æ ¼é“¾æ¥</label>
                    <input type="url" id="bitableUrl" placeholder="https://xxxxxxxx.feishu.cn/base/xxxxxxxxxxxxxxx"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">è¡¨æ ¼ID (Table ID)</label>
                    <input type="text" id="tableId" placeholder="tblxxxxxxxxxxxxxxx"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">è§†å›¾ID (View ID)</label>
                    <input type="text" id="viewId" placeholder="vewxxxxxxxxxxxxxxx"
                           class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>

                <div class="flex gap-3">
                    <button onclick="saveConfig()"
                            class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                        ğŸ’¾ ä¿å­˜é…ç½®
                    </button>
                    <button onclick="hideConfigPanel()"
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        âŒ å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é£ä¹¦é…ç½®
        let feishuConfig = {
            appId: '',
            appSecret: '',
            bitableUrl: '',
            tableId: '',
            viewId: '',
            tenantAccessToken: ''
        };

        // ä»localStorageåŠ è½½é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem('feishuConfig');
            if (saved) {
                feishuConfig = { ...feishuConfig, ...JSON.parse(saved) };
                updateConfigInputs();
            }
        }

        // æ›´æ–°é…ç½®è¾“å…¥æ¡†
        function updateConfigInputs() {
            document.getElementById('appId').value = feishuConfig.appId;
            document.getElementById('appSecret').value = feishuConfig.appSecret;
            document.getElementById('bitableUrl').value = feishuConfig.bitableUrl;
            document.getElementById('tableId').value = feishuConfig.tableId;
            document.getElementById('viewId').value = feishuConfig.viewId;
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            feishuConfig.appId = document.getElementById('appId').value;
            feishuConfig.appSecret = document.getElementById('appSecret').value;
            feishuConfig.bitableUrl = document.getElementById('bitableUrl').value;
            feishuConfig.tableId = document.getElementById('tableId').value;
            feishuConfig.viewId = document.getElementById('viewId').value;

            localStorage.setItem('feishuConfig', JSON.stringify(feishuConfig));
            showMessage('âœ… é…ç½®å·²ä¿å­˜', 'success');
            hideConfigPanel();
        }

        // æ˜¾ç¤º/éšè—é…ç½®é¢æ¿
        function showConfigPanel() {
            document.getElementById('configPanel').classList.remove('hidden');
        }

        function hideConfigPanel() {
            document.getElementById('configPanel').classList.add('hidden');
        }

        // è·å–ç§Ÿæˆ·è®¿é—®ä»¤ç‰Œ
        async function getTenantAccessToken() {
            if (!feishuConfig.appId || !feishuConfig.appSecret) {
                throw new Error('è¯·å…ˆé…ç½®é£ä¹¦åº”ç”¨IDå’Œå¯†é’¥');
            }

            const response = await fetch('https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    app_id: feishuConfig.appId,
                    app_secret: feishuConfig.appSecret
                })
            });

            const data = await response.json();
            if (data.code === 0) {
                return data.tenant_access_token;
            } else {
                throw new Error(`è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: ${data.msg}`);
            }
        }

        // æ·»åŠ è®°å½•åˆ°é£ä¹¦å¤šç»´è¡¨æ ¼
        async function addRecordToFeishu(formData) {
            try {
                // è·å–è®¿é—®ä»¤ç‰Œ
                const accessToken = await getTenantAccessToken();

                // è§£æè¡¨æ ¼é“¾æ¥è·å–app_tokenå’Œspreadsheet_token
                const urlMatch = feishuConfig.bitableUrl.match(/base\/([a-zA-Z0-9]+)/);
                if (!urlMatch) {
                    throw new Error('æ— æ•ˆçš„é£ä¹¦è¡¨æ ¼é“¾æ¥');
                }
                const appToken = urlMatch[1];

                // æ„é€ è®°å½•æ•°æ®
                const recordData = {
                    fields: {
                        "å§“å": formData.name,
                        "æ‰‹æœºå·": formData.phone,
                        "é‚®ç®±": formData.email || '',
                        "ç•™è¨€å†…å®¹": formData.message,
                        "æäº¤æ—¶é—´": new Date().toLocaleString('zh-CN'),
                        "çŠ¶æ€": "å¾…å¤„ç†",
                        "æ¥æº": "å®˜ç½‘è¡¨å•"
                    }
                };

                // æ·»åŠ è®°å½•
                const response = await fetch(`https://open.feishu.cn/open-apis/bitable/v1/apps/${appToken}/tables/${feishuConfig.tableId}/records`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(recordData)
                });

                const result = await response.json();
                if (result.code === 0) {
                    return result.data;
                } else {
                    throw new Error(`æ·»åŠ è®°å½•å¤±è´¥: ${result.msg}`);
                }

            } catch (error) {
                console.error('é£ä¹¦åŒæ­¥å¤±è´¥:', error);
                throw error;
            }
        }

        // æµ‹è¯•é£ä¹¦è¿æ¥
        async function testFeishuConnection() {
            try {
                showMessage('ğŸ”„ æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
                const accessToken = await getTenantAccessToken();
                showMessage('âœ… é£ä¹¦è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
            } catch (error) {
                showMessage(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰“å¼€é£ä¹¦è¡¨æ ¼
        function openFeishuTable() {
            if (feishuConfig.bitableUrl) {
                window.open(feishuConfig.bitableUrl, '_blank');
            } else {
                showMessage('è¯·å…ˆé…ç½®é£ä¹¦è¡¨æ ¼é“¾æ¥', 'error');
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'success') {
            const statusDiv = document.getElementById('statusMessage');
            const bgColor = type === 'success' ? 'bg-green-100 text-green-800 border-green-200' :
                           type === 'error' ? 'bg-red-100 text-red-800 border-red-200' :
                           'bg-blue-100 text-blue-800 border-blue-200';
            statusDiv.className = `mt-4 p-4 rounded-lg border ${bgColor}`;
            statusDiv.innerHTML = message;
            statusDiv.classList.remove('hidden');

            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // éªŒè¯è¡¨å•
        function validateForm(formData) {
            if (!formData.name.trim()) {
                showMessage('âŒ è¯·è¾“å…¥æ‚¨çš„å§“å', 'error');
                return false;
            }

            const phoneRegex = /^1[3-9]\d{9}$/;
            if (!phoneRegex.test(formData.phone.trim())) {
                showMessage('âŒ è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·ç ', 'error');
                return false;
            }

            if (formData.message.trim().length < 10) {
                showMessage('âŒ ç•™è¨€å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦', 'error');
                return false;
            }

            return true;
        }

        // è¡¨å•æäº¤
        document.getElementById('contactForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                name: document.getElementById('name').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                email: document.getElementById('email').value.trim(),
                message: document.getElementById('message').value.trim()
            };

            if (!validateForm(formData)) {
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const btnLoading = document.getElementById('btnLoading');

            // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
            submitBtn.disabled = true;
            btnText.textContent = 'æäº¤ä¸­...';
            btnLoading.classList.remove('hidden');

            try {
                // ä¿å­˜åˆ°æœ¬åœ°å¤‡ä»½
                const submissions = JSON.parse(localStorage.getItem('contactSubmissions') || '[]');
                const newSubmission = {
                    id: Date.now(),
                    ...formData,
                    timestamp: new Date().toLocaleString('zh-CN'),
                    status: 'pending'
                };
                submissions.push(newSubmission);
                localStorage.setItem('contactSubmissions', JSON.stringify(submissions));

                // å°è¯•åŒæ­¥åˆ°é£ä¹¦
                let feishuSynced = false;
                if (feishuConfig.appId && feishuConfig.appSecret && feishuConfig.tableId) {
                    try {
                        await addRecordToFeishu(formData);
                        feishuSynced = true;
                        console.log('âœ… æ•°æ®å·²åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼');
                    } catch (error) {
                        console.warn('é£ä¹¦åŒæ­¥å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°:', error);
                    }
                }

                // æ›´æ–°ç»Ÿè®¡
                updateStats();

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const syncMsg = feishuSynced ? 'æ•°æ®å·²åŒæ­¥åˆ°é£ä¹¦è¡¨æ ¼' : 'æ•°æ®å·²ä¿å­˜ï¼Œå°†ç¨ååŒæ­¥';
                showMessage(`âœ… æäº¤æˆåŠŸï¼${syncMsg}ï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸æ‚¨è”ç³»ã€‚`, 'success');

                // é‡ç½®è¡¨å•
                this.reset();

            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showMessage('âŒ æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                btnText.textContent = 'æäº¤å’¨è¯¢';
                btnLoading.classList.add('hidden');
            }
        });

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const submissions = JSON.parse(localStorage.getItem('contactSubmissions') || '[]');
            document.getElementById('totalSubmissions').textContent = submissions.length;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            loadConfig();
            updateStats();

            // æ£€æŸ¥é£ä¹¦é…ç½®çŠ¶æ€
            if (feishuConfig.appId && feishuConfig.appSecret) {
                document.getElementById('syncStatus').textContent = 'âœ… å·²é…ç½®';
            } else {
                document.getElementById('syncStatus').textContent = 'âš ï¸ æœªé…ç½®';
            }
        });

        // è‡ªåŠ¨åŒæ­¥æœ¬åœ°æ•°æ®åˆ°é£ä¹¦ï¼ˆå¦‚æœé…ç½®äº†çš„è¯ï¼‰
        async function syncLocalDataToFeishu() {
            if (!feishuConfig.appId || !feishuConfig.appSecret || !feishuConfig.tableId) {
                return;
            }

            const submissions = JSON.parse(localStorage.getItem('contactSubmissions') || '[]');
            const syncedIds = JSON.parse(localStorage.getItem('feishuSyncedIds') || '[]');

            for (const submission of submissions) {
                if (!syncedIds.includes(submission.id)) {
                    try {
                        await addRecordToFeishu(submission);
                        syncedIds.push(submission.id);
                        localStorage.setItem('feishuSyncedIds', JSON.stringify(syncedIds));
                        console.log(`âœ… å·²åŒæ­¥è®°å½• ${submission.id} åˆ°é£ä¹¦`);
                    } catch (error) {
                        console.warn(`åŒæ­¥è®°å½• ${submission.id} å¤±è´¥:`, error);
                    }
                }
            }
        }

        // æ¯5åˆ†é’Ÿå°è¯•åŒæ­¥ä¸€æ¬¡
        setInterval(syncLocalDataToFeishu, 5 * 60 * 1000);
    </script>
</body>
</html>