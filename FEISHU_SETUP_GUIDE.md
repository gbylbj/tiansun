# 🚀 飞书多维表格集成完整指南

## 📋 概述

本指南将帮助您将网站表单数据自动同步到飞书多维表格，实现客户数据的实时收集和管理。

## 🎯 功能特点

- ✅ **实时同步**：客户提交表单后自动同步到飞书表格
- ✅ **数据备份**：本地存储 + 飞书云端双重备份
- ✅ **自动重试**：网络故障时自动重试同步
- ✅ **管理界面**：可视化配置和监控界面
- ✅ **零代码**：无需编写后端代码

## 🔧 设置步骤

### 第一步：创建飞书应用

1. **登录飞书开发者后台**
   - 访问：https://open.feishu.cn/app
   - 使用飞书账号登录

2. **创建企业自建应用**
   - 点击"创建企业自建应用"
   - 应用名称：港埠雨林留言收集
   - 应用描述：收集官网客户留言信息
   - 应用图标：选择合适图标

3. **获取应用凭证**
   - 创建成功后，进入应用详情页
   - 在"凭证与基础信息"页面找到：
     - `App ID`（应用ID）
     - `App Secret`（应用密钥）

### 第二步：配置应用权限

1. **添加权限范围**
   - 进入"权限管理"页面
   - 添加以下权限：
     - `bitable:app` - 多维表格应用权限
     - `bitable:app:readonly` - 多维表格只读权限
     - `bitable:app:write` - 多维表格写入权限

2. **申请发布**
   - 在"版本管理与发布"页面
   - 创建版本并申请发布
   - 等待审核通过（通常很快）

### 第三步：创建多维表格

1. **新建多维表格**
   - 在飞书中打开"多维表格"
   - 点击"新建多维表格"
   - 选择"从空白创建"

2. **设计表格结构**
   创建以下字段：

   | 字段名称 | 字段类型 | 说明 |
   |---------|---------|------|
   | 姓名 | 单行文本 | 客户姓名 |
   | 手机号 | 单行文本 | 联系电话 |
   | 邮箱 | 单行文本 | 邮箱地址 |
   | 留言内容 | 多行文本 | 客户留言 |
   | 提交时间 | 日期时间 | 自动记录时间 |
   | 状态 | 单选 | 待处理/已处理/已联系 |
   | 来源 | 单行文本 | 官网表单 |

3. **获取表格信息**
   - 在表格页面，复制浏览器地址栏中的URL
   - URL格式：`https://xxx.feishu.cn/base/[appToken]`
   - 记录 `appToken`（base后面的字符串）

4. **获取表格ID和视图ID**
   - 打开浏览器开发者工具（F12）
   - 在Console中执行以下代码获取ID：
   ```javascript
   // 获取当前表格的ID信息
   window.location.pathname.match(/base\/([^\/]+)/)?.[1] // appToken
   document.querySelector('[data-testid="table-view-selector"]')?.getAttribute('data-table-id') // tableId
   ```

   或者在URL中查找：
   - 表格ID通常以 `tbl` 开头
   - 视图ID通常以 `vew` 开头

### 第四步：配置网站

1. **打开配置页面**
   - 访问 `FEISHU_INTEGRATION.html`
   - 点击"管理员" → "飞书配置"

2. **填入配置信息**
   ```
   应用ID: cli_xxxxxxxxxxxxxxxx
   应用密钥: your_app_secret_here
   多维表格链接: https://xxx.feishu.cn/base/appToken
   表格ID: tblxxxxxxxxxxxxxxx
   视图ID: vewxxxxxxxxxxxxxxx
   ```

3. **保存配置**
   - 点击"保存配置"
   - 系统会自动保存到浏览器本地存储

4. **测试连接**
   - 点击"测试连接"按钮
   - 如果显示"连接测试成功"，说明配置正确

## 🚀 使用方法

### 客户提交流程

1. **客户访问网站**
   - 客户在您的官网上填写联系表单
   - 点击"提交咨询"按钮

2. **数据处理**
   - 系统首先保存数据到浏览器本地存储
   - 然后尝试同步到飞书多维表格
   - 如果同步失败，会自动重试

3. **状态反馈**
   - 客户看到"提交成功"提示
   - 管理员可以查看同步状态

### 管理员操作

1. **查看数据**
   - 直接访问飞书多维表格
   - 或点击网站上的"打开飞书表格"

2. **数据处理**
   - 在飞书中标记处理状态
   - 添加跟进记录
   - 导出数据进行进一步分析

3. **监控状态**
   - 网站底部显示同步状态
   - 实时显示总留言数量

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 连接测试失败
**可能原因：**
- 应用ID或密钥错误
- 权限未正确配置
- 应用未发布审核

**解决方案：**
- 检查应用ID和密钥是否正确
- 确认已添加必要的权限
- 确保应用已通过审核

#### 2. 数据同步失败
**可能原因：**
- 网络连接问题
- 表格ID或视图ID错误
- 飞书API限流

**解决方案：**
- 检查网络连接
- 验证表格ID和视图ID
- 等待一段时间后重试

#### 3. 权限不足
**可能原因：**
- 应用权限配置不完整
- 表格分享权限问题

**解决方案：**
- 确认应用有必要的权限
- 检查表格的分享设置

### 调试方法

1. **打开浏览器开发者工具**
   - 按F12打开开发者工具
   - 查看Console标签页的错误信息

2. **检查网络请求**
   - 在Network标签页查看API请求
   - 确认请求状态和响应内容

3. **查看飞书应用日志**
   - 在飞书开发者后台查看应用日志
   - 检查是否有错误记录

## 📈 优化建议

### 数据管理

1. **定期备份**
   - 定期导出飞书表格数据
   - 建立数据归档制度

2. **自动化处理**
   - 在飞书中设置自动化规则
   - 自动标记处理状态

3. **数据分析**
   - 利用飞书的数据分析功能
   - 生成客户需求报告

### 安全考虑

1. **权限控制**
   - 限制飞书应用的访问权限
   - 定期更换应用密钥

2. **数据保护**
   - 遵守数据保护法规
   - 妥善处理客户隐私信息

## 🎯 高级功能

### 自定义字段映射

如果需要自定义字段映射，可以修改 `addRecordToFeishu` 函数：

```javascript
const recordData = {
  fields: {
    "姓名": formData.name,
    "手机号": formData.phone,
    "自定义字段": formData.customField,
    // 添加更多字段...
  }
};
```

### 批量同步历史数据

```javascript
// 在浏览器控制台中执行
async function syncAllLocalData() {
  const submissions = JSON.parse(localStorage.getItem('contactSubmissions') || '[]');
  for (const submission of submissions) {
    try {
      await addRecordToFeishu(submission);
      console.log(`已同步: ${submission.name}`);
    } catch (error) {
      console.error(`同步失败: ${submission.name}`, error);
    }
  }
}
syncAllLocalData();
```

## 📞 技术支持

如果遇到问题，可以：

1. 查看飞书开发者文档
2. 检查浏览器控制台错误信息
3. 验证所有配置参数是否正确
4. 联系飞书技术支持

---

**完成以上步骤后，您的网站就能自动将客户留言同步到飞书多维表格了！**